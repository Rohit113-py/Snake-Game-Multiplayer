<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snake Arena - Multiplayer Snake Game</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        
        :root {
            --primary: #4ade80;
            --secondary: #3b82f6;
            --accent: #f59e0b;
            --dark: #1e293b;
            --light: #f8fafc;
        }
        
        body {
            font-family: 'Press Start 2P', cursive;
            background-color: var(--dark);
            color: var(--light);
            overflow-x: hidden;
        }
        
        .game-container {
            position: relative;
            margin: 0 auto;
            width: 100%;
            max-width: 600px;
            border: 8px solid var(--accent);
            border-radius: 8px;
            box-shadow: 0 0 30px rgba(251, 191, 36, 0.3);
        }
        
        #game-board {
            background-color: #0f172a;
            display: grid;
            grid-template-columns: repeat(20, 1fr);
            grid-template-rows: repeat(20, 1fr);
            height: 70vh;
            max-height: 600px;
        }
        
        .snake {
            background-color: var(--primary);
            border: 1px solid #22c55e;
            border-radius: 50%;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.3);
        }
        
        .snake-head {
            background-color: #16a34a;
            position: relative;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            z-index: 2;
        }
        
        .snake-head::after {
            content: '';
            position: absolute;
            top: 25%;
            left: 25%;
            width: 6px;
            height: 6px;
            background-color: white;
            border-radius: 50%;
            box-shadow: 0 0 2px black;
        }
        
        .food {
            background-color: var(--accent);
            border-radius: 50%;
            animation: pulse 0.8s infinite alternate;
            box-shadow: 0 0 15px rgba(251, 191, 36, 0.7);
            position: relative;
        }
        
        .food::before {
            content: '';
            position: absolute;
            top: 15%;
            left: 15%;
            width: 20%;
            height: 20%;
            background: rgba(255,255,255,0.8);
            border-radius: 50%;
            filter: blur(1px);
        }
        
        .obstacle {
            background-color: #64748b;
        }
        
        .other-player {
            background-color: var(--secondary);
            border: 1px solid #2563eb;
            border-radius: 50%;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.3);
        }
        
        .other-player-head {
            background-color: #1d4ed8;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            z-index: 2;
        }
        
        .other-player-head::after {
            content: '';
            position: absolute;
            top: 25%;
            left: 25%;
            width: 6px;
            height: 6px;
            background-color: white;
            border-radius: 50%;
            box-shadow: 0 0 2px black;
        }
        
        @keyframes pulse {
            0% { transform: scale(0.9) rotate(0deg); }
            50% { transform: scale(1.1) rotate(5deg); }
            100% { transform: scale(0.9) rotate(0deg); }
        }
        
        .login-container {
            background: rgba(30, 41, 59, 0.9);
            backdrop-filter: blur(10px);
        }
        
        .player-badge {
            background: rgba(30, 41, 59, 0.7);
            border: 2px solid var(--accent);
        }
        
        .transition-all {
            transition: all 0.3s ease;
        }
        
        .btn {
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 15px rgba(251, 191, 36, 0.4);
        }
        
        .mode-btn.active {
            background-color: var(--accent);
            color: var(--dark);
            border-color: var(--accent);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <!-- Login Screen -->
    <div id="login-screen" class="fixed inset-0 flex items-center justify-center z-50 login-container">
        <div class="bg-slate-800 p-8 rounded-lg shadow-2xl w-full max-w-md mx-4">
            <div class="text-center mb-8">
                <img src="https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/046c3d1d-f289-40f3-9d5c-b47713e7de41.png" alt="Snake Arena logo with snake illustration and game title" class="mx-auto mb-6" />
                <h1 class="text-2xl font-bold text-orange-400 mb-2">Welcome to Snake Arena</h1>
                <p class="text-slate-300 mb-6">Login to play with friends across the world!</p>
            </div>
            
            <div class="space-y-4">
                <div id="g_id_onload"
                    data-client_id="YOUR_GOOGLE_CLIENT_ID.apps.googleusercontent.com"
                    data-context="signin"
                    data-ux_mode="popup"
                    data-callback="handleGoogleSignIn"
                    data-auto_prompt="false">
                </div>

                <div class="g_id_signin"
                    data-type="standard"
                    data-shape="rectangular"
                    data-theme="filled_blue"
                    data-text="signin_with"
                    data-size="large"
                    data-logo_alignment="left">
                </div>

                <div id="fb-login-button" 
                    class="fb-login-button bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg w-full flex items-center justify-center btn"
                    data-size="large"
                    data-button-type="continue_with"
                    data-layout="default"
                    data-auto-logout-link="false"
                    data-use-continue-as="false">
                    <span class="flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                            <path fill-rule="evenodd" d="M22 12c0-5.523-4.477-10-10-10S2 6.477 2 12c0 4.991 3.657 9.128 8.438 9.878v-6.987h-2.54V12h2.54V9.797c0-2.506 1.492-3.89 3.777-3.89 1.094 0 2.238.195 2.238.195v2.46h-1.26c-1.243 0-1.63.771-1.63 1.562V12h2.773l-.443 2.89h-2.33v6.988C18.343 21.128 22 16.991 22 12z" clip-rule="evenodd"></path>
                        </svg>
                        Continue with Facebook
                    </span>
                </div>
                
                <div class="relative flex items-center py-2">
                    <div class="flex-grow border-t border-slate-600"></div>
                    <span class="flex-shrink mx-4 text-slate-400">or</span>
                    <div class="flex-grow border-t border-slate-600"></div>
                </div>
                
                <div>
                    <input type="email" id="email" placeholder="Email" class="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-orange-400 mb-3" />
                    <input type="password" id="password" placeholder="Password" class="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-orange-400" />
                    <button onclick="handleEmailSignIn()" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-4 rounded-lg mt-4 btn">Continue with Email</button>
                </div>
            </div>
            
            <div class="mt-6 text-center text-sm text-slate-400">
                By continuing, you agree to our <a href="#" class="text-orange-400 hover:underline">Terms</a> and <a href="#" class="text-orange-400 hover:underline">Privacy Policy</a>.
            </div>
        </div>
    </div>

    <!-- Game UI -->
    <div id="game-ui" class="hidden">
        <header class="py-4 px-6 bg-slate-800 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <img id="player-avatar" src="https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/f3ae6a46-0c1f-4bfc-9827-e69b4cf4b647.png" alt="Player avatar image" class="w-10 h-10 rounded-full border-2 border-orange-400" />
                <div>
                    <h2 id="player-name" class="text-orange-400 font-bold">Guest</h2>
                    <p class="text-xs text-slate-400"><span id="player-score">0</span> points</p>
                </div>
            </div>
            
            <div class="flex space-x-2">
                <button id="invite-btn" class="bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold py-2 px-3 rounded-lg flex items-center btn">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    Invite
                </button>
                <button id="settings-btn" class="bg-slate-700 hover:bg-slate-600 text-white text-xs font-bold py-2 px-3 rounded-lg btn">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                </button>
            </div>
        </header>
        
        <main class="flex-1 flex flex-col">
            <div class="p-4 bg-slate-800">
                <div class="flex justify-center space-x-4 mb-4">
                    <button id="btn-single" class="mode-btn active bg-transparent hover:bg-orange-500 text-orange-400 font-semibold hover:text-white py-2 px-4 border border-orange-400 hover:border-transparent rounded btn transition-all">
                        Single Player
                    </button>
                    <button id="btn-multi" class="mode-btn bg-transparent hover:bg-orange-500 text-orange-400 font-semibold hover:text-white py-2 px-4 border border-orange-400 hover:border-transparent rounded btn transition-all">
                        Multiplayer
                    </button>
                </div>
                
                <div id="lobby" class="bg-slate-700 rounded-lg p-4 hidden">
                    <h3 class="text-orange-400 font-bold mb-3 text-center">Game Lobby</h3>
                    <div id="players-list" class="grid grid-cols-2 gap-2">
                        <!-- Players will be added here dynamically -->
                    </div>
                    <div class="mt-4 flex justify-center">
                        <button id="start-game-btn" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-6 rounded-lg btn" disabled>
                            Start Game
                        </button>
                    </div>
                </div>
                
                <div class="flex justify-between items-center mt-2 px-2">
                    <div class="text-orange-400 text-sm">High Score: <span id="high-score">0</span></div>
                    <div class="text-blue-400 text-sm" id="online-count">0 players online</div>
                </div>
            </div>
            
            <div class="game-container mt-4 mx-auto">
                <div id="game-board"></div>
            </div>
            
            <div id="game-over" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-40">
                <div class="bg-slate-800 p-8 rounded-lg w-full max-w-md mx-4 text-center">
                    <h2 class="text-2xl font-bold text-orange-400 mb-4">Game Over!</h2>
                    <p class="text-xl mb-6">Your score: <span id="final-score" class="text-orange-400">0</span></p>
                    <div class="flex justify-center space-x-4">
                        <button id="btn-play-again" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-6 rounded-lg btn">
                            Play Again
                        </button>
                        <button id="btn-main-menu" class="bg-slate-700 hover:bg-slate-600 text-white font-bold py-2 px-6 rounded-lg btn">
                            Menu
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Game State
        let gameActive = false;
        let currentMode = 'single'; // 'single' or 'multi'
        let snake = [];
        let food = {};
        let obstacles = [];
        let otherPlayers = {};
        let direction = 'right';
        let nextDirection = 'right';
        let gameSpeed = 150;
        let score = 0;
        let highScore = localStorage.getItem('snakeHighScore') || 0;
        let gameLoop;
        let gridSize = 20;
        
        // Auth State
        let user = {
            id: null,
            name: 'Guest',
            email: null,
            avatar: 'https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/80bae2ff-7657-461c-b50a-2c475fd19b94.png',
            provider: null
        };
        
        // Multiplayer State
        let roomId = null;
        let socket = null;
        let playersInLobby = [];
        let isHost = false;
        
        // DOM Elements
        const loginScreen = document.getElementById('login-screen');
        const gameUI = document.getElementById('game-ui');
        const playerNameEl = document.getElementById('player-name');
        const playerAvatarEl = document.getElementById('player-avatar');
        const playerScoreEl = document.getElementById('player-score');
        const highScoreEl = document.getElementById('high-score');
        const gameBoard = document.getElementById('game-board');
        const gameOverScreen = document.getElementById('game-over');
        const finalScoreEl = document.getElementById('final-score');
        const btnPlayAgain = document.getElementById('btn-play-again');
        const btnMainMenu = document.getElementById('btn-main-menu');
        const btnSingle = document.getElementById('btn-single');
        const btnMulti = document.getElementById('btn-multi');
        const lobby = document.getElementById('lobby');
        const playersList = document.getElementById('players-list');
        const startGameBtn = document.getElementById('start-game-btn');
        const inviteBtn = document.getElementById('invite-btn');
        const onlineCountEl = document.getElementById('online-count');
        
        // Initialize game board
        function initGameBoard() {
            gameBoard.innerHTML = '';
            gameBoard.style.gridTemplateColumns = `repeat(${gridSize}, 1fr)`;
            gameBoard.style.gridTemplateRows = `repeat(${gridSize}, 1fr)`;
        }
        
        // Game Logic
        function startGame() {
            gameActive = true;
            score = 0;
            playerScoreEl.textContent = score;
            snake = [{x: 10, y: 10}];
            direction = 'right';
            nextDirection = 'right';
            spawnFood();
            spawnObstacles();
            
            if (currentMode === 'multi' && socket) {
                socket.emit('startGame', { roomId });
            }
            
            clearInterval(gameLoop);
            gameLoop = setInterval(gameTick, gameSpeed);
        }
        
        function gameTick() {
            if (!gameActive) return;
            
            moveSnake();
            
            if (currentMode === 'single') {
                checkCollision();
            }
            
            if (checkFoodCollision()) {
                score += 10;
                playerScoreEl.textContent = score;
                if (score > highScore) {
                    highScore = score;
                    highScoreEl.textContent = highScore;
                    localStorage.setItem('snakeHighScore', highScore);
                }
                spawnFood();
                if (currentMode === 'multi' && socket) {
                    socket.emit('foodEaten', { roomId, newFood: food });
                }
            }
            
            renderGame();
            
            if (currentMode === 'multi' && socket) {
                socket.emit('playerMove', { 
                    roomId, 
                    playerId: user.id, 
                    position: snake[0], 
                    direction: nextDirection 
                });
            }
        }
        
        function moveSnake() {
            direction = nextDirection;
            const head = {...snake[0]};
            
            switch (direction) {
                case 'up':
                    head.y = (head.y - 1 + gridSize) % gridSize;
                    break;
                case 'down':
                    head.y = (head.y + 1) % gridSize;
                    break;
                case 'left':
                    head.x = (head.x - 1 + gridSize) % gridSize;
                    break;
                case 'right':
                    head.x = (head.x + 1) % gridSize;
                    break;
            }
            
            snake.unshift(head);
            snake.pop();
            
            // Check collisions after movement
            checkCollision();
        }
        
        function checkCollision() {
            if (!gameActive) return;
            const head = snake[0];
            
            // Wall collision check
            if (head.x < 0 || head.x >= gridSize || head.y < 0 || head.y >= gridSize) {
                gameOver();
                return;
            }
            
            // Self collision
            for (let i = 1; i < snake.length; i++) {
                if (head.x === snake[i].x && head.y === snake[i].y) {
                    gameOver();
                    return;
                }
            }
            
            // Obstacle collision
            for (let obstacle of obstacles) {
                if (head.x === obstacle.x && head.y === obstacle.y) {
                    gameOver();
                    return;
                }
            }
        }
        
        function checkFoodCollision() {
            const head = snake[0];
            if (head.x === food.x && head.y === food.y) {
                // Grow snake
                snake.push({...snake[snake.length - 1]});
                return true;
            }
            return false;
        }
        
        function spawnFood() {
            let newFood;
            let validPosition = false;
            
            while (!validPosition) {
                newFood = {
                    x: Math.floor(Math.random() * gridSize),
                    y: Math.floor(Math.random() * gridSize)
                };
                
                validPosition = true;
                
                // Check if on snake
                for (let segment of snake) {
                    if (segment.x === newFood.x && segment.y === newFood.y) {
                        validPosition = false;
                        break;
                    }
                }
                
                // Check if on obstacles
                for (let obstacle of obstacles) {
                    if (obstacle.x === newFood.x && obstacle.y === newFood.y) {
                        validPosition = false;
                        break;
                    }
                }
                
                // In multiplayer, check other players
                if (currentMode === 'multi') {
                    for (let playerId in otherPlayers) {
                        for (let segment of otherPlayers[playerId].snake) {
                            if (segment.x === newFood.x && segment.y === newFood.y) {
                                validPosition = false;
                                break;
                            }
                        }
                        if (!validPosition) break;
                    }
                }
            }
            
            food = newFood;
            return food;
        }
        
        function spawnObstacles() {
            obstacles = [];
            const obstacleCount = Math.floor(gridSize * 0.5);
            
            for (let i = 0; i < obstacleCount; i++) {
                let newObstacle;
                let validPosition = false;
                
                while (!validPosition) {
                    newObstacle = {
                        x: Math.floor(Math.random() * gridSize),
                        y: Math.floor(Math.random() * gridSize)
                    };
                    
                    validPosition = true;
                    
                    // Not on existing obstacles
                    for (let obstacle of obstacles) {
                        if (obstacle.x === newObstacle.x && obstacle.y === newObstacle.y) {
                            validPosition = false;
                            break;
                        }
                    }
                    
                    // Not on snake head
                    if (newObstacle.x === snake[0].x && newObstacle.y === snake[0].y) {
                        validPosition = false;
                    }
                    
                    // Not too close to snake head
                    const distanceToHead = Math.abs(newObstacle.x - snake[0].x) + Math.abs(newObstacle.y - snake[0].y);
                    if (distanceToHead < 3) {
                        validPosition = false;
                    }
                }
                
                obstacles.push(newObstacle);
            }
        }
        
        function renderGame() {
            // Clear board
            gameBoard.innerHTML = '';
            
            // Draw snake
            snake.forEach((segment, index) => {
                const segmentEl = document.createElement('div');
                segmentEl.classList.add(index === 0 ? 'snake-head' : 'snake');
                segmentEl.style.gridColumnStart = segment.x + 1;
                segmentEl.style.gridRowStart = segment.y + 1;
                gameBoard.appendChild(segmentEl);
            });
            
            // Draw other players
            for (let playerId in otherPlayers) {
                const player = otherPlayers[playerId];
                player.snake.forEach((segment, index) => {
                    const segmentEl = document.createElement('div');
                    segmentEl.classList.add(index === 0 ? 'other-player-head' : 'other-player');
                    segmentEl.style.gridColumnStart = segment.x + 1;
                    segmentEl.style.gridRowStart = segment.y + 1;
                    gameBoard.appendChild(segmentEl);
                    
                    if (index === 0) {
                        // Add player name badge
                        const badge = document.createElement('div');
                        badge.textContent = player.name;
                        badge.classList.add('absolute', 'text-xs', 'bg-slate-800', 'px-1', 'rounded', 'text-orange-400');
                        badge.style.left = `${segment.x * 30}px`;
                        badge.style.top = `${(segment.y - 1) * 30}px`;
                        gameBoard.appendChild(badge);
                    }
                });
            }
            
            // Draw food
            const foodEl = document.createElement('div');
            foodEl.classList.add('food');
            foodEl.style.gridColumnStart = food.x + 1;
            foodEl.style.gridRowStart = food.y + 1;
            gameBoard.appendChild(foodEl);
            
            // Draw obstacles
            obstacles.forEach(obstacle => {
                const obstacleEl = document.createElement('div');
                obstacleEl.classList.add('obstacle');
                obstacleEl.style.gridColumnStart = obstacle.x + 1;
                obstacleEl.style.gridRowStart = obstacle.y + 1;
                gameBoard.appendChild(obstacleEl);
            });
        }
        
        function gameOver() {
            gameActive = false;
            clearInterval(gameLoop);
            finalScoreEl.textContent = score;
            gameOverScreen.classList.remove('hidden');
            
            if (currentMode === 'multi' && socket) {
                socket.emit('playerGameOver', { roomId, playerId: user.id });
            }
        }
        
        // Auth Functions
        function handleGoogleSignIn(response) {
            const userProfile = decodeJWT(response.credential);
            
            user = {
                id: userProfile.sub,
                name: userProfile.name,
                email: userProfile.email,
                avatar: userProfile.picture,
                provider: 'google'
            };
            
            updateUserUI();
            hideLoginScreen();
            connectToMultiplayer();
        }
        
        function handleFBLogin(response) {
            console.log('FB Login Response', response);
            // FB SDK needs to be loaded separately
            alert('Facebook login would be implemented with FB SDK');
        }
        
        function handleEmailSignIn() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                alert('Please enter both email and password');
                return;
            }
            
            // In a real app, you would verify credentials with your backend
            user = {
                id: `email-${Date.now()}`,
                name: email.split('@')[0],
                email: email,
                avatar: 'https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/375eeb25-b3eb-4f9d-b959-34d8d3a25a79.png' + email[0].toUpperCase(),
                provider: 'email'
            };
            
            updateUserUI();
            hideLoginScreen();
            connectToMultiplayer();
        }
        
        function decodeJWT(token) {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            
            return JSON.parse(jsonPayload);
        }
        
        function updateUserUI() {
            playerNameEl.textContent = user.name;
            playerAvatarEl.src = user.avatar;
            playerAvatarEl.alt = `${user.name}'s avatar`;
            highScoreEl.textContent = highScore;
        }
        
        function hideLoginScreen() {
            loginScreen.classList.add('hidden');
            gameUI.classList.remove('hidden');
            initGameBoard();
        }
        
        // Multiplayer Functions
        function connectToMultiplayer() {
            // In a real app, you would connect to your WebSocket server
            console.log(`Connecting ${user.name} to multiplayer server...`);
            
            // Mock socket connection for demonstration
            socket = {
                emit: function(event, data) {
                    console.log(`Emitting ${event}:`, data);
                },
                on: function(event, callback) {
                    console.log(`Listening for ${event}`);
                    // Mock events for demo
                    if (event === 'playersOnline') {
                        setTimeout(() => callback({ count: 42 }), 500);
                    }
                    if (event === 'roomCreated') {
                        setTimeout(() => callback({ 
                            roomId: 'demo-room-' + Date.now(),
                            players: [
                                { id: user.id, name: user.name, avatar: user.avatar, isReady: true },
                                { id: 'player-2', name: 'Player 2', avatar: 'https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/3de8f168-1cbc-4f83-a279-9737ee7590d4.png', isReady: false },
                                { id: 'player-3', name: 'Player 3', avatar: 'https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/9460b964-a8bb-43cd-98cf-10eaadf8f2b4.png', isReady: false }
                            ],
                            isHost: true
                        }), 1000);
                    }
                    if (event === 'playerJoined') {
                        setTimeout(() => callback({ 
                            player: { id: 'player-4', name: 'Player 4', avatar: 'https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/033b895e-a129-4bce-a95e-0127d3690faa.png', isReady: false }
                        }), 1500);
                    }
                    if (event === 'gameStateUpdate') {
                        setTimeout(() => callback({
                            food: { x: 5, y: 5 },
                            players: {
                                'player-1': {
                                    snake: [{x: 10, y: 10}, {x: 9, y: 10}, {x: 8, y: 10}],
                                    direction: 'right',
                                    score: 0
                                },
                                'player-2': {
                                    snake: [{x: 10, y: 15}, {x: 10, y: 16}, {x: 10, y: 17}],
                                    direction: 'up',
                                    score: 0
                                }
                            }
                        }), 2000);
                    }
                },
                disconnect: function() {
                    console.log('Disconnected from socket');
                }
            };
            
            // Set up socket event listeners
            socket.on('playersOnline', (data) => {
                onlineCountEl.textContent = `${data.count} players online`;
            });
            
            socket.on('roomCreated', (data) => {
                roomId = data.roomId;
                isHost = data.isHost;
                playersInLobby = data.players;
                updateLobbyPlayers();
                
                if (isHost) {
                    startGameBtn.disabled = playersInLobby.length < 2;
                }
            });
            
            socket.on('playerJoined', (data) => {
                playersInLobby.push(data.player);
                updateLobbyPlayers();
                
                if (isHost) {
                    startGameBtn.disabled = false;
                }
            });
            
            socket.on('playerLeft', (data) => {
                playersInLobby = playersInLobby.filter(p => p.id !== data.playerId);
                updateLobbyPlayers();
                
                if (isHost) {
                    startGameBtn.disabled = playersInLobby.length < 2;
                }
            });
            
            socket.on('gameStateUpdate', (data) => {
                food = data.food;
                otherPlayers = data.players;
                
                // Remove current player from otherPlayers if present
                if (user.id in otherPlayers) {
                    delete otherPlayers[user.id];
                }
                
                renderGame();
            });
            
            socket.on('playerGameOver', (data) => {
                if (otherPlayers[data.playerId]) {
                    delete otherPlayers[data.playerId];
                    renderGame();
                }
            });
            
            // Initialize connection
            socket.emit('init', { player: user });
        }
        
        function updateLobbyPlayers() {
            playersList.innerHTML = '';
            
            playersInLobby.forEach(player => {
                const playerEl = document.createElement('div');
                playerEl.className = 'flex items-center p-2 bg-slate-800 rounded player-badge';
                playerEl.innerHTML = `
                    <img src="${player.avatar}" alt="${player.name}'s avatar" class="w-8 h-8 rounded-full mr-2" />
                    <span class="text-sm">${player.name}</span>
                    ${player.isReady ? '<span class="ml-auto text-xs text-green-400">Ready</span>' : '<span class="ml-auto text-xs text-orange-400">Waiting</span>'}
                `;
                playersList.appendChild(playerEl);
            });
        }
        
        function inviteFriend() {
            const inviteLink = `${window.location.origin}?room=${roomId}`;
            
            // In a real app, you would use Web Share API or a library
            if (navigator.share) {
                navigator.share({
                    title: 'Join my Snake Game!',
                    text: `${user.name} invited you to play Snake Arena`,
                    url: inviteLink
                }).catch(err => {
                    console.log('Error sharing:', err);
                    fallbackCopy(inviteLink);
                });
            } else {
                fallbackCopy(inviteLink);
            }
        }
        
        function fallbackCopy(inviteLink) {
            const textarea = document.createElement('textarea');
            textarea.value = inviteLink;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            
            alert('Invite link copied to clipboard:\n' + inviteLink);
        }
        
        // Event Listeners
        document.addEventListener('keydown', (e) => {
            if (!gameActive) return;
            
            switch (e.key) {
                case 'ArrowUp':
                    if (direction !== 'down') nextDirection = 'up';
                    break;
                case 'ArrowDown':
                    if (direction !== 'up') nextDirection = 'down';
                    break;
                case 'ArrowLeft':
                    if (direction !== 'right') nextDirection = 'left';
                    break;
                case 'ArrowRight':
                    if (direction !== 'left') nextDirection = 'right';
                    break;
            }
        });
        
        btnPlayAgain.addEventListener('click', () => {
            gameOverScreen.classList.add('hidden');
            startGame();
        });
        
        btnMainMenu.addEventListener('click', () => {
            gameOverScreen.classList.add('hidden');
            // Return to main menu logic
        });
        
        btnSingle.addEventListener('click', () => {
            currentMode = 'single';
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            btnSingle.classList.add('active');
            lobby.classList.add('hidden');
            
            if (socket) {
                socket.disconnect();
                socket = null;
            }
            
            startGame();
        });
        
        btnMulti.addEventListener('click', () => {
            currentMode = 'multi';
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            btnMulti.classList.add('active');
            lobby.classList.remove('hidden');
            
            if (!socket) {
                connectToMultiplayer();
            }
        });
        
        startGameBtn.addEventListener('click', () => {
            if (isHost) {
                startGame();
            }
        });
        
        inviteBtn.addEventListener('click', inviteFriend);
        
        // Floating controls for mobile
        const floatingControls = document.createElement('div');
        floatingControls.className = 'fixed bottom-4 right-4 flex flex-col space-y-2 z-30';
        floatingControls.innerHTML = `
            <button id="btn-up" class="bg-slate-700 hover:bg-slate-600 text-white font-bold w-12 h-12 rounded-full flex items-center justify-center shadow-lg btn">
                ↑
            </button>
            <div class="flex space-x-2 justify-center">
                <button id="btn-left" class="bg-slate-700 hover:bg-slate-600 text-white font-bold w-12 h-12 rounded-full flex items-center justify-center shadow-lg btn">
                    ←
                </button>
                <button id="btn-right" class="bg-slate-700 hover:bg-slate-600 text-white font-bold w-12 h-12 rounded-full flex items-center justify-center shadow-lg btn">
                    →
                </button>
            </div>
            <button id="btn-down" class="bg-slate-700 hover:bg-slate-600 text-white font-bold w-12 h-12 rounded-full flex items-center justify-center shadow-lg btn">
                ↓
            </button>
        `;
        document.body.appendChild(floatingControls);
        
        document.getElementById('btn-up').addEventListener('click', () => {
            if (direction !== 'down') nextDirection = 'up';
        });
        
        document.getElementById('btn-down').addEventListener('click', () => {
            if (direction !== 'up') nextDirection = 'down';
        });
        
        document.getElementById('btn-left').addEventListener('click', () => {
            if (direction !== 'right') nextDirection = 'left';
        });
        
        document.getElementById('btn-right').addEventListener('click', () => {
            if (direction !== 'left') nextDirection = 'right';
        });
        
        // Initialize
        updateUserUI();
        
        // For demo purposes, auto-login after 1 second if not logged in
        setTimeout(() => {
            if (user.id === null) {
                user = {
                    id: 'demo-user-' + Date.now(),
                    name: 'Demo Player',
                    email: 'demo@snakearena.com',
                    avatar: 'https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/937d241a-7d98-4e1b-b401-3ece13899b25.png',
                    provider: 'demo'
                };
                updateUserUI();
                hideLoginScreen();
            }
        }, 1000);
    </script>
</body>
</html>
